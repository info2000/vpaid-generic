<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Javascript VPAID example</title>
  <style type="text/css">
    body {
      font-family: sans-serif;
      padding: 0;
      margin: 0;
    }

    #mainContainer {
      position: relative;
      width: 640px;
      height: 360px;
    }

    #content, #adContainer {
      position: absolute;
      top: 0px;
      left: 0px;
      width: 640px;
      height: 360px;
    }

    #contentElement {
      width: 640px;
      height: 360px;
      overflow: hidden;
    }

    .btn {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 24px;
      font-size: 1.1em;
      text-transform: uppercase;
      color: white;
      text-align: center;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
      background: #2c3e50;
      border: 0;
      cursor: pointer;
    }

    #remainingTimeContainer {
      padding: 12px 0;
      font-size: 1.4em;
    }

    button:focus { outline: 0; }
  </style>
</head>
<body>
  <div id="mainContainer">
    <div id="content">
      <video id="contentElement">
        <source src="http://rmcdn.2mdn.net/Demo/vast_inspector/android.mp4"></source>
        <source src="http://rmcdn.2mdn.net/Demo/vast_inspector/android.webm"></source>
      </video>
    </div>
    <div id="adContainer"></div>
  </div>
  <button id="playButton" class="btn">Play</button>
  <button id="skipButton" class="btn">Skip</button>
  <button id="fullscreenButton" class="btn">Fullscreen</button>
  <div id="remainingTimeContainer">
    Remaining: <span id="remainingTimeDisplay"></span>
  </div>
  <script type="text/javascript" src="//imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
  <script type="text/javascript">
    var adsManager, adsLoader, adDisplayContainer, intervalTimer, playButton, skipButton, videoContent, remainingTimeContainer, remainingTimeDisplay, adInit = false, adLoaded = false, adStarted = false;

    function init() {
      videoContent = document.getElementById('contentElement');
      playButton = document.getElementById('playButton');
      skipButton = document.getElementById('skipButton');
      remainingTimeContainer = document.getElementById('remainingTimeContainer');
      remainingTimeDisplay = document.getElementById('remainingTimeDisplay');
      playButton.addEventListener('click', playAds);
      skipButton.addEventListener('click', skipAds);
      fullscreenButton.addEventListener('click', fullscreenAds);
      setUpIMA();
    }

    function setUpIMA() {
      createAdDisplayContainer();
      adsLoader = new google.ima.AdsLoader(adDisplayContainer);
      adsLoader.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED, onAdsManagerLoaded, false);
      adsLoader.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, onAdError, false);

      var contentEndedListener = function() {adsLoader.contentComplete();};
      videoContent.onended = contentEndedListener;

      // Request video ads.
      var adsRequest = new google.ima.AdsRequest();
      adsRequest.adsResponse = '<?xml version="1.0" encoding="UTF-8"?> <VAST version="2.0"> <Ad id="601364"> <InLine> <AdSystem>Acudeo Compatible</AdSystem> <AdTitle>VAST 2.0 Instream Test 1</AdTitle> <Description>VAST 2.0 Instream Test 1</Description> <Creatives> <Creative AdID="601364"> <Linear> <Duration>00:00:30</Duration> <AdParameters> <![CDATA[ {"videoURL": "http://cdn.visiblemeasures.com/ad_assets/p/c5899/3/12-Enjoy Your Drink_KY Online.mp4", "clickThrough": "http://www.yahoo.com/"} ]]> </AdParameters> <MediaFiles> <MediaFile apiFramework="VPAID" width="640" height="360" type="application/javascript" delivery="progressive">http://localhost:8080/demo.bundle.js</MediaFile> </MediaFiles> </Linear> </Creative> </Creatives> </InLine> </Ad> </VAST>';

      adsRequest.linearAdSlotWidth = 640;
      adsRequest.linearAdSlotHeight = 400;

      adsRequest.nonLinearAdSlotWidth = 640;
      adsRequest.nonLinearAdSlotHeight = 150;

      adsLoader.requestAds(adsRequest);
    }


    function createAdDisplayContainer() {
      adDisplayContainer = new google.ima.AdDisplayContainer(document.getElementById('adContainer'), videoContent);
    }

    function playAds() {
      videoContent.load();
      adDisplayContainer.initialize();

      if(!adInit && !adLoaded && !adStarted) {
        try {
          adsManager.init(640, 360, google.ima.ViewMode.NORMAL);
          adsManager.start();
          adInit = true;
        } catch (adError) {
          videoContent.play();
        }
      } else if(playButton.innerHTML == 'Play') {
        adsManager.resume();
      } else if(playButton.innerHTML == 'Pause') {
        adsManager.pause();
      }

      playButton.innerHTML = playButton.innerHTML == 'Play' ? 'Pause' : 'Play';
    }

    function skipAds() {
      if(adInit && adLoaded && adStarted) {
        adsManager.skip();
      }
    }

    function fullscreenAds() {
      var existingDimensions = contentElement.getBoundingClientRect();

      adsManager.resize(window.innerWidth, window.innerHeight, google.ima.ViewMode.FULLSCREEN);

      document.addEventListener('keydown', function escapeFullscreen(evt) {
        if(evt.key == 'Escape' || evt.key == 'Esc' || evt.keyCode == 27) {
          document.removeEventListener('keydown', escapeFullscreen);
          adsManager.resize(existingDimensions.width, existingDimensions.height, google.ima.ViewMode.NORMAL);
        }
      });
    }

    function onAdsManagerLoaded(adsManagerLoadedEvent) {
      // Get the ads manager.
      var adsRenderingSettings = new google.ima.AdsRenderingSettings();
      adsRenderingSettings.restoreCustomPlaybackStateOnAdBreakComplete = true;
      // videoContent should be set to the content video element.
      adsManager = adsManagerLoadedEvent.getAdsManager(videoContent, adsRenderingSettings);

      // Add listeners to the required events.
      adsManager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR, onAdError);
      adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED, onContentPauseRequested);
      adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED, onContentResumeRequested);
      adsManager.addEventListener(google.ima.AdEvent.Type.ALL_ADS_COMPLETED, onAdEvent);

      // Listen to any additional events, if necessary.
      adsManager.addEventListener(google.ima.AdEvent.Type.CLICK, onAdEvent);
      adsManager.addEventListener(google.ima.AdEvent.Type.LOADED, onAdEvent);
      adsManager.addEventListener(google.ima.AdEvent.Type.STARTED, onAdEvent);
      adsManager.addEventListener(google.ima.AdEvent.Type.SKIPPED, onAdEvent);
      adsManager.addEventListener(google.ima.AdEvent.Type.PROGRESS, onAdEvent);
      adsManager.addEventListener(google.ima.AdEvent.Type.COMPLETE, onAdEvent);
      adsManager.addEventListener(google.ima.AdEvent.Type.MIDPOINT, onAdEvent);
      adsManager.addEventListener(google.ima.AdEvent.Type.FIRST_QUARTILE, onAdEvent);
      adsManager.addEventListener(google.ima.AdEvent.Type.THIRD_QUARTILE, onAdEvent);
      adsManager.addEventListener(google.ima.AdEvent.Type.DURATION_CHANGE, onAdEvent);
    }

    function onAdEvent(adEvent) {
      console.log('onAdEvent', adEvent);
      var ad = adEvent.getAd();
      switch (adEvent.type) {
        case google.ima.AdEvent.Type.LOADED:
          adLoaded = true;
          
          if (!ad.isLinear()) {
            videoContent.play();
          }
          break;

        case google.ima.AdEvent.Type.STARTED:
          if (ad.isLinear()) {
            adStarted = true;
            intervalTimer = setInterval(
                function() {
                  var remainingTime = adsManager.getRemainingTime();
                  remainingTimeDisplay.innerHTML = remainingTime.toFixed(2);
                },
                300); // every 300ms
          }
          break;

        case google.ima.AdEvent.Type.SKIPPED:
          clearInterval(intervalTimer);
          remainingTimeContainer.style.display = 'none';
          break;

        case google.ima.AdEvent.Type.COMPLETE:
          if (ad.isLinear()) {
            clearInterval(intervalTimer);
            remainingTimeContainer.style.display = 'none';
          }
          break;
      }
    }

    function onAdError(adErrorEvent) {
      console.log(adErrorEvent.getError());
      adsManager.destroy();
    }

    function onContentPauseRequested() {
      videoContent.pause();
    }

    function onContentResumeRequested() {
      videoContent.play();
    }

    init();
  </script>
</body>
</html>